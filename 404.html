<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        if (window.location.pathname.endsWith(".html")) {
            var clean = window.location.pathname.replace(".html", "");
            window.history.replaceState(null, "", clean);
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Me | xdtip</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Special Styles just for Tipping Page */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .avatar-circle {
            width: 80px; height: 80px;
            background: #222;
            border-radius: 50%;
            margin: 0 auto 15px auto;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; border: 2px solid #ff3b3b;
            color: #fff;
            overflow: hidden; /* Ensures image stays inside circle */
        }
        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chip-grid {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .chip {
            flex: 1; padding: 10px;
            background: #111; border: 1px solid #333;
            color: white; border-radius: 8px; cursor: pointer;
            text-align: center; transition: 0.2s;
        }
        .chip:hover, .chip.active {
            background: #ff3b3b; border-color: #ff3b3b;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/index/" style="text-decoration:none; color:white;">
            <div class="logo">
    <img src="images/logo.png" alt="XDTIP" style="height: 40px; vertical-align: middle;">
</div>
        </a>
        <div class="nav-links">
            </div>
    </nav>

    <nav>
        <div class="logo">xdtip<span class="dot">.</span></div>
        <a href="/dashboard/" style="font-size:14px;">Back to Dashboard</a>
    </nav>

    <div class="container" style="max-width: 450px; margin-top: 60px;">
        
        <div class="profile-header">
            <div class="avatar-circle" id="avatar-placeholder">?</div>
            <h1 style="font-size: 24px; margin: 0;">Support <span id="creator-name" style="color: #ff3b3b;">Creator</span></h1>
            <p style="color: #888; font-size: 14px; margin-top: 5px;">Thank you for supporting my stream!</p>
        </div>

        <form id="tip-form">
            <input type="hidden" id="receiver">

            <label style="font-size: 12px; color: #666; font-weight: bold;">SELECT AMOUNT</label>
            <div class="chip-grid">
                <div class="chip" onclick="setAmount(10)">10</div>
                <div class="chip" onclick="setAmount(100)">100</div>
                <div class="chip" onclick="setAmount(500)">500</div>
            </div>
            <input type="number" id="amount" placeholder="Or enter custom amount..." min="10" required>
            
            <label style="font-size: 12px; color: #666; font-weight: bold; margin-top: 10px; display:block;">YOUR MESSAGE</label>
            <textarea id="message" rows="3" placeholder="Say something nice for the alert..." required 
                style="width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 6px; box-sizing: border-box; resize: none;"></textarea>
            
            <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Send Support</button>
        </form>
    </div>

    <footer>
        <p>&copy; 2024 xdtip. All rights reserved.</p>
    </footer>

    <script>
        // ‚ö†Ô∏è UPDATED TO YOUR BACKEND URL (Use the one that works)
        const API_URL = "https://xdtip-backend.onrender.com"; 

        // 1. MAIN LOAD LOGIC
        window.onload = async function() {
            // ---------------------------------------------------------
            // 1. GET THE PATH (e.g. "xdfunYT" or "login")
            // ---------------------------------------------------------
            const path = window.location.pathname;
            let slug = path.substring(1); // Remove leading slash "/"

            // Clean up: Remove trailing slash
            if (slug.endsWith('/')) {
                slug = slug.slice(0, -1);
            }

            // -----------------------------------------------------
            // üõë 2. SYSTEM PAGE REDIRECTOR (THE FIX)
            // -----------------------------------------------------
            // If the URL is one of these, go to the .html file instead of searching for a user
            const systemPages = [
                'login', 'register', 'dashboard', 
                'about', 'contact', 'terms', 
                'privacy', 'refund-policy', 'buy', 
                'forgot', 'reset', 'index', 'learn-more.html', 'terms', 'tip'
            ];

            if (systemPages.includes(slug.toLowerCase())) {
                window.location.href = '/' + slug + '.html';
                return; // STOP HERE
            }

            // ---------------------------------------------------------
            // üë§ 3. USERNAME PROFILE LOGIC
            // ---------------------------------------------------------
            
            // If URL is empty or just "index.html", show the Search Box
            if (!slug || slug === "index.html" || slug === "tip") {
                showSearchBox();
                return;
            }

            // If we are here, "slug" is a Username (e.g. xdfunYT)
            // Set hidden receiver field
            const receiverField = document.getElementById('receiver');
            if(receiverField) receiverField.value = slug;
            
            try {
                // Fetch Creator Details (Logo)
                const res = await fetch(`${API_URL}/profile/${slug}`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('creator-name').innerText = data.user.username;
                    
                    // Show Logo or Avatar
                    const avatarBox = document.getElementById('avatar-placeholder');
                    if (data.user.logo_url) {
                        avatarBox.innerHTML = `<img src="${data.user.logo_url}" alt="Logo">`;
                        avatarBox.style.border = "2px solid #00ff88"; 
                    } else {
                        // UI Avatars Fallback
                        avatarBox.innerHTML = `<img src="https://ui-avatars.com/api/?name=${data.user.username}&background=00ff88&color=000&size=128" alt="Logo">`;
                    }
                } else {
                    // User not found in backend
                    console.error("User not found");
                    showSearchBox();
                }
            } catch (err) {
                console.error("Could not load profile", err);
                showSearchBox();
            }
        };

        // ---------------------------------------------------------
        // HELPER FUNCTIONS
        // ---------------------------------------------------------

        function showSearchBox() {
             document.querySelector('.profile-header').innerHTML = `
                <h1 style="text-align:center;">Send a Tip</h1>
                <p style="color:#888; font-size:14px; text-align:center;">Enter a username to support them.</p>
                <input type="text" placeholder="Enter Creator Username" 
                style="margin-top:20px; text-align:center; width:100%; padding:15px; background:#111; border:1px solid #333; color:white; border-radius:8px;" 
                onchange="window.location.href = '/' + this.value">
            `;
        }

        // Chip Selection Helper
        function setAmount(val) {
             document.getElementById('amount').value = val;
             document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
             event.target.classList.add('active');
        }

        // ---------------------------------------------------------
        // üí∏ SUBMIT TIP LOGIC
        // ---------------------------------------------------------
        document.getElementById('tip-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            if(!token) {
                alert("Please Login to send a tip!");
                return window.location.href = "/login.html"; // Ensure .html is here
            }

            const receiverUsername = document.getElementById('receiver').value;
            const amount = document.getElementById('amount').value;
            const message = document.getElementById('message').value;
            const btn = e.target.querySelector('button');

            if(!receiverUsername) return alert("Please enter a creator username");

            try {
                btn.innerText = "Sending...";
                const res = await fetch(`${API_URL}/tip`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ receiverUsername, amount, message })
                });

                const data = await res.json();
                
                if (data.success) {
                    alert("Tip Sent Successfully! üéâ");
                    window.location.href = "/dashboard.html"; // Ensure .html is here
                } else {
                    alert("Failed: " + data.error);
                }
            } catch (err) {
                alert("Server Error");
            } finally {
                btn.innerText = "Send Support";
            }
        });
    </script>
    <footer>
        <p>&copy; 2024 xdtip. All rights reserved.</p>
        <div class="footer-links">
            <a href="/privacy/">Privacy Policy</a>
            <a href="/terms/">Terms of Service</a>
            <a href="/refund-policy/">Refund Policy</a>
            <a href="/contact/">Contact Us</a>
        </div>
    </footer>
</body>
</html>




