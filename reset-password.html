<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        if (window.location.pathname.endsWith(".html")) {
            var clean = window.location.pathname.replace(".html", "");
            window.history.replaceState(null, "", clean);
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password | XDTIP</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container" style="max-width: 400px; margin-top: 50px; text-align: center;">
        <img src="images/logo.png" style="height: 50px; margin-bottom: 20px;">
        <h2>New Password</h2>
        
        <div id="status-box" style="background:#111; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #333;">
            <p style="color:#888; font-size: 12px; margin:0;">Connection Status:</p>
            <p id="user-status" style="color: yellow; font-weight:bold; font-size: 13px; margin:5px 0;">Wait...</p>
        </div>

        <div style="position: relative; margin-bottom: 15px;">
            <input type="password" id="new-password" placeholder="New Password" style="width: 100%; padding: 12px; padding-right: 40px; background: #111; border: 1px solid #333; color: white; border-radius: 5px;">
            <i id="eye-icon" class="fas fa-eye" onclick="togglePass()" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; z-index: 10;"></i>
        </div>

        <button id="update-btn" onclick="updatePassword()" class="btn" disabled style="width: 100%; padding: 12px; background: #333; color: #666; font-weight: bold; border: none; cursor: not-allowed; border-radius: 5px;">
            Wait for Connection...
        </button>
        
        <p id="message" style="margin-top: 15px; font-size: 13px;"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ---------------------------------------------------------
        // 1. CONFIGURATION
        // ---------------------------------------------------------
        const mySupabaseUrl = 'https://abatvqodkwjdefhwwynj.supabase.co'; 
        const mySupabaseKey = 'sb_publishable_TePONQyxqJL1A-zaO-iUeQ_h8lAllWV'; 

        const resetClient = window.supabase.createClient(mySupabaseUrl, mySupabaseKey);

        // ---------------------------------------------------------
        // 2. STRICT SESSION CHECKER
        // ---------------------------------------------------------
        resetClient.auth.onAuthStateChange(async (event, session) => {
            const statusText = document.getElementById('user-status');
            const btn = document.getElementById('update-btn');

            if (session && session.user) {
                // ✅ WE ARE LOGGED IN
                statusText.innerHTML = "✅ Securely Connected<br><span style='font-size:10px; color:#666'>" + session.user.email + "</span>";
                statusText.style.color = "#00ff88"; 
                
                // Enable Button
                btn.disabled = false;
                btn.style.background = "#00ff88";
                btn.style.color = "black";
                btn.style.cursor = "pointer";
                btn.innerText = "Update Password";
            } else {
                // ❌ NOT LOGGED IN
                statusText.innerText = "❌ No Connection. Link Invalid.";
                statusText.style.color = "red";
                
                // Disable Button
                btn.disabled = true;
                btn.style.background = "#333";
                btn.style.color = "#666";
                btn.innerText = "Link Expired";
            }
        });

        // ---------------------------------------------------------
        // 3. TOGGLE PASSWORD
        // ---------------------------------------------------------
        window.togglePass = function() {
            const input = document.getElementById('new-password');
            const icon = document.getElementById('eye-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace('fa-eye', 'fa-eye-slash');
                icon.style.color = "#00ff88";
            } else {
                input.type = "password";
                icon.classList.replace('fa-eye-slash', 'fa-eye');
                icon.style.color = "#666";
            }
        }

        // ---------------------------------------------------------
        // 4. UPDATE PASSWORD
        // ---------------------------------------------------------
        window.updatePassword = async function() {
            const newPassword = document.getElementById('new-password').value;
            const msg = document.getElementById('message');
            const btn = document.querySelector('button');

            if(newPassword.length < 6) {
                alert("Password must be at least 6 characters.");
                return;
            }

            btn.innerText = "Processing...";
            btn.disabled = true;
            msg.innerText = "";
            
            try {
                // FORCE REFRESH SESSION TO BE SURE
                const { data: { session }, error: sessionError } = await resetClient.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error("Connection lost. Please click the email link again.");
                }

                // ACTUAL UPDATE
                const { data, error } = await resetClient.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                // SUCCESS
                msg.innerText = "✅ Password Updated!";
                msg.style.color = "#00ff88";
                btn.innerText = "Success";
                
                alert("✅ PASSWORD UPDATED!\n\nWe will now log you out so you can test the new password.");

                // LOGOUT TO CLEAR OLD DATA
                await resetClient.auth.signOut();
                
                setTimeout(() => {
                    window.location.href = 'https://tip.xdfun.in/login';
                }, 1000);

            } catch (err) {
                console.error("Critical Error:", err);
                msg.innerText = "❌ Error: " + err.message;
                msg.style.color = "red";
                btn.innerText = "Try Again";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
