<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        if (window.location.pathname.endsWith(".html")) {
            var clean = window.location.pathname.replace(".html", "");
            window.history.replaceState(null, "", clean);
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password | XDTIP</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container" style="max-width: 400px; margin-top: 50px; text-align: center;">
        <img src="images/logo.png" style="height: 50px; margin-bottom: 20px;">
        <h2>New Password</h2>
        <p style="color:#888; font-size: 14px;">Create a secure password.</p>

        <div style="position: relative; margin-bottom: 15px;">
            <input type="password" id="new-password" placeholder="New Password" style="width: 100%; padding: 12px; padding-right: 40px; background: #111; border: 1px solid #333; color: white; border-radius: 5px;">
            <i class="fas fa-eye" onclick="togglePass()" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer;"></i>
        </div>

        <button onclick="updatePassword()" class="btn" style="width: 100%; padding: 12px; background: #00ff88; color: black; font-weight: bold; border: none; cursor: pointer; border-radius: 5px;">Update Password</button>
        
        <p id="message" style="margin-top: 15px; font-size: 13px;"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ---------------------------------------------------------
        // 2. CONFIGURATION
        // ---------------------------------------------------------
        
        // ⚠️ PASTE YOUR KEYS HERE (The same ones from forgot-password.html)
        const supabaseUrl = 'https://abatvqodkwjdefhwwynj.supabase.co'; 
        const supabaseKey = 'sb_publishable_TePONQyxqJL1A-zaO-iUeQ_h8lAllWV'; // Public Anon Key

        // Initialize Supabase Client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ---------------------------------------------------------
        // 3. PAGE LOGIC
        // ---------------------------------------------------------

        // A. Verify user is allowed to be here
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === "PASSWORD_RECOVERY") {
                console.log("Recovery mode verified. User is authorized.");
            } else if (!session) {
                // If no session exists, it means the link is invalid or expired
                // However, we give it a split second to check local storage
                setTimeout(() => {
                    supabase.auth.getSession().then(({ data: { session } }) => {
                        if (!session) {
                            document.body.innerHTML = `
                                <div style="text-align:center; margin-top:50px; color:white;">
                                    <h3>Invalid or Expired Link</h3>
                                    <p>Please request a new password reset link.</p>
                                    <a href="https://tip.xdfun.in/forgot-password" style="color:#00ff88">Go Back</a>
                                </div>`;
                        }
                    });
                }, 1000);
            }
        });

        // B. Toggle Password Visibility
        function togglePass() {
            const input = document.getElementById('new-password');
            const icon = document.querySelector('.fa-eye');
            if (input.type === "password") {
                input.type = "text";
                icon.style.color = "#00ff88";
            } else {
                input.type = "password";
                icon.style.color = "#666";
            }
        }

        // C. Update Password Function
        async function updatePassword() {
            const newPassword = document.getElementById('new-password').value;
            const msg = document.getElementById('message');
            const btn = document.querySelector('button');

            if(newPassword.length < 6) {
                alert("Password must be at least 6 characters.");
                return;
            }

            btn.innerText = "Updating...";
            btn.disabled = true;
            msg.innerText = "";
            
            try {
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) {
                    throw error;
                }

                // Success
                msg.innerText = "✅ Password Changed! Redirecting...";
                msg.style.color = "#00ff88";
                btn.innerText = "Success";
                
                alert("✅ Success! Your password has been changed.");
                
                // Redirect to Login
                setTimeout(() => {
                    window.location.href = 'https://tip.xdfun.in/login';
                }, 2000);

            } catch (err) {
                console.error("Update Error:", err);
                msg.innerText = "❌ Error: " + err.message;
                msg.style.color = "red";
                btn.innerText = "Try Again";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
